<!doctype html>
<html>
    <head>
        <title>分布式数据服务实时监控中心</title>
		<meta http-equiv="content-type" content="text/html;charset=utf-8" />
		<link rel="stylesheet" href="./css/network.css">

		<script src="./asset/js/esl/esl.js"></script>
		<script src="./asset/js/codemirror.js"></script>
		<script src="./asset/js/javascript.js"></script>
		<script src="./asset/js/ScriptEngine.js"></script>
		<link href="./asset/css/bootstrap.css" rel="stylesheet">
		<link href="./asset/css/bootstrap-responsive.css" rel="stylesheet">
		<link href="./asset/css/codemirror.css" rel="stylesheet">
		<link href="./asset/css/monokai.css" rel="stylesheet">
		<link href="./asset/css/echartsHome.css" rel="stylesheet">
		<link href="./asset/css/zTreeStyle.css" rel="stylesheet">

		<link rel="shortcut icon" href="./asset/ico/favicon.png">
    </head>
	<body>
		<div class="container-bai">
			<div id="test" class="banner">
				<img src="./image/logo.jpg" alt="logo" width="521" height="63"/>
			</div>
			<div class="content">
				<div id="graphic" class="span8" style="width:1300px !important;padding-left:250px;">
					<canvas id="main" width="84%" height="1000px">
					</canvas>
					<div id="smear" style="z-index:-1;"></div>
					<div>
					</div>
				</div>
				<div id="tree" class="data-tree">
					<div class="tree-header">
						<img class="header-icon1" src="./image/header-icon.png" alt="icon" width="22" height="22"/>节点管理器
						<img class="header-icon2" src="./image/header-icon-1.png" alt="icon" width="22" height="22"/>
					</div>
					<!-- <div class="tree-header2">
						<img class="header-icon3" id="img-1" src="./asset/ico/fy.png" alt="icon" width="16" height="19"/>数据中心服务(3)
						<img class="header-icon4" id="img-2" src="./image/arrow-2.png" alt="icon" width="16" height="16"/>
					</div>
					<div class="center-service" style="display: block;">
						<div id="ztree1" class="ztree">
						</div>
					</div>
					<div class="tree-header2" style="background:#263948;" >
						<img class="header-icon3" src="./asset/ico/fy.png" alt="icon" width="16" height="19"/>数据中心服务(3)
						<img class="header-icon4" src="./image/arrow-2.png" alt="icon" width="16" height="16"/>
					</div>
                    <div class="center-service" >
                        <div id="ztree2" class="ztree">
                        </div>
                    </div>
					<div class="tree-header2" style="background:#263948;" >
						<img class="header-icon3" src="./asset/ico/fy.png" alt="icon" width="16" height="19"/>数据中心服务(2)
						<img class="header-icon4" src="./image/arrow-2.png" alt="icon" width="16" height="16"/>
					</div>
                    <div class="center-service">
                        <div id="ztree3" class="ztree">
                        </div>
                    </div>
					<div class="tree-header2" style="background:#263948;">
						<img class="header-icon3" src="./asset/ico/fy.png" alt="icon" width="16" height="19"/>数据中心服务(2)
						<img class="header-icon4" src="./image/arrow-2.png" alt="icon" width="16" height="16"/>
					</div>
                    <div class="center-service">
                        <div id="ztree4" class="ztree">
                        </div>
                    </div>
					<div class="tree-header2" style="background:#263948;border-radius:0 0 5px 5px;" >
						<img class="header-icon3" src="./asset/ico/fy.png" alt="icon" width="16" height="19"/>数据中心服务(2)
						<img class="header-icon4" src="./image/arrow-2.png" alt="icon" width="16" height="16"/>
					</div>
                    <div class="center-service">
                        <div id="ztree5" class="ztree">
                        </div>
                    </div>
 -->
				</div>

				<div class="data-tree-2" id="data-network">
				</div>
				<div class="data-tree-3">
					<div class="tree-header">
						<img class="header-icon1" src="./image/header-icon.png" alt="icon" width="22" height="22"/>日志显示
						<img class="header-icon2" src="./image/header-icon-1.png" alt="icon" width="22" height="22"/>
					</div>
					<div class="log">
						<span class="num">001</span>
						<span class="time">23:59:59</span>
						<span class="log-con">日志的内容日志的内容日志的内容日志的内容日志的内容日志的内容日志的</span>
					</div>
					<div class="log">
						<span class="num">001</span>
						<span class="time">23:59:59</span>
						<span class="log-con">日志的内容日志的内容日志的内容日志的内容日志的内容日志的内容日志的</span>
					</div>
					<div class="log">
						<span class="num">001</span>
						<span class="time">23:59:59</span>
						<span class="log-con">日志的内容日志的内容日志的内容日志的内容日志的内容日志的内容日志的</span>
					</div>
					<div class="log">
						<span class="num">001</span>
						<span class="time">23:59:59</span>
						<span class="log-con">日志的内容日志的内容日志的内容日志的内容日志的内容日志的内容日志的</span>
					</div>

				</div>
			</div>
		</div>
		<script src="./asset/js/jquery.js"></script>
		<script type="text/javascript" src="./asset/js/jquery.ztree-all-min.js"></script>
		<script type="text/javascript" src="./asset/CanvasXpress/js/canvasXpress.min.js"></script>
		<script src="./asset/js/lufylegend.min.js" type="text/javascript"></script>

		<script>
		window.onbeforeunload = function() {   
            var n = window.event.screenX - window.screenLeft;   
            var b = n > document.documentElement.scrollWidth-20;   
            if(b && window.event.clientY < 0 || window.event.altKey){   
                if(webSocket) {
                	webSocket.close();
                } 
            }else{
                if(webSocket) {
                	webSocket.close();
                } 
            }
        }  

       $('.tree-header2').click(function(){
            showTree();
        });

		var showTree = function(){
			var treeHeader = event.target;
			var treeContent = event.target.nextElementSibling;
			if(treeContent.style.display != ''){
				treeContent.style.display = '';
				treeHeader.style.background = "#263948";
			}else{
				treeContent.style.display = 'block';
				treeHeader.style.background = "#24313e";
			}
		}
		function findDataAccess(st, rt) {
			 var se = new ScriptEngine();
			 se.setClass("pku.edu.cn.nodeoperation.NodeOperation");
			 se.setMethod("getNodeInfo");
			 var re = se.invoke(st, rt);
			 return re;
		} 
		function accessCenterNode(){
			var centerNode =  findDataAccess(arguments[0], arguments[1]);
			document.getElementById("data-network").innerHTML = '<div class="tree-header"><img class="header-icon1" src="./image/header-icon.png" 	alt="icon" width="22" height="22"/><span id="network-name">数据中心</span><img class="header-icon2" src="./image/header-icon-1.png" alt="icon" width="22" height="22"/></div><div class="tree-header2" style="padding-left:20px;  width:214px;color:#5489a6;">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;目标&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;目标值</div><div class="center-service"  style="padding-left:20px; width:214px;border-radius:0 0 5px 5px;display: block;">1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+centerNode.ip+'<br/>2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;主从中心&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+centerNode.centerType+'<br/>3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;地理位置&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+centerNode.position+'<br/>4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;存储容量&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+centerNode.capacity+'<br/>5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;服务容量&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+centerNode.serverCapacity+'<br/></div>'}
		function accessANode(){
			var ANode =  findDataAccess(arguments[0], arguments[1])
			var html='<div class="tree-header"><img class="header-icon1" src="./image/header-icon.png" alt="icon" width="22" height="22"/><span 		id="network-name">数据访问节点</span><img class="header-icon2" src="./image/header-icon-1.png" alt="icon" width="22" height="22"/></div><div class="tree-header2" style="padding-left:20px;  width:214px;color:#5489a6;">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;目标&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;目标值</div><div class="center-service"  style="padding-left:20px; width:214px;border-radius:0 0 5px 5px;display: block;">1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+ANode.ip+'<br/>2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;访问类型&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+ANode.type+'<br/>';
			var childip=ANode.userIpList;
			for(var i =0;i<childip.length;i++){
			console.log(childip[i])
			var tmp=i+1;
			var lable = tmp+2;
			html+=lable+'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;用户系统'+tmp+'&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+childip[i]+'<br/>';
			}			
			html+='</div>';
			document.getElementById("data-network").innerHTML = html;
		}
		function accessSysNode(){
			var sysNode =  findDataAccess(arguments[0], arguments[1])
			document.getElementById("data-network").innerHTML = '<div class="tree-header"><img class="header-icon1" src="./image/header-icon.png" alt="icon" width="22" height="22"/><span id="network-name">用户系统</span><img class="header-icon2" src="./image/header-icon-1.png" alt="icon" width="22" height="22"/></div><div class="tree-header2" style="padding-left:20px;  width:214px;color:#5489a6;">#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;目标&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;目标值</div><div class="center-service"  style="padding-left:20px; width:214px;border-radius:0 0 5px 5px;display: block;">1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+sysNode.ip+'<br/>2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;所属机构&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+sysNode.sub+'<br/>3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;系统类型&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;'+sysNode.type+'<br/></div>'}
			//ztree全局定义
		var setting = {
			edit: {
				enable: false,
				editNameSelectAll: true,
			},
			data: {
				simpleData: {
					enable: true
				}
			},
			async:{
			    type:"post",
				enable:true,
				contentType:"application/json",
				url:""
			},
			callback:{
				asyncSuccess: zTreeOnAsyncSuccess,
				asyncError: zTreeOnAsyncError,
				onClick: zTreeOnClick
			}
		};

		function zTreeOnAsyncError(event, treeId, treeNode){ 
			alert("异步加载失败!"); 
		}
		function zTreeOnAsyncSuccess(event, treeId, treeNode, msg){ 
				console.log(msg);
		}
		function zTreeOnClick(event, treeId, treeNode) {
			if(treeNode.stdname=="用户系统"){ 	//数据访问节点具体信息	
				accessSysNode(treeNode.id, 0)	
			}					
			else { 	//用户系统具体信息
				accessANode(treeNode.id, 1)
			}
		}
		//ztree test data
		var zNodes =[];

       $(document).ready(function(){

       		$.ajax( {
            type : "GET",
            url : getRootPath() + "/api/v1/ztree/ztree/centernode",
            cache : false,
            async : false,
            success : function(data) {
                console.log(data);
                addZtreeCenterNode(data);
            },
            error :function(data){
                result= data;
            }
        });

       });
		function addZtreeCenterNode(data){
			var json = eval('(' + data + ')'); 
			var tmp =0;
			for(var o in json){
				console.log(json[o].name);

				var center = '<div class="tree-header2"><img class="header-icon3" id="img-1" src="./asset/ico/fy.png" alt="icon" width="16" height="19"/>'+json[o].name+'<img class="header-icon4" id="img-2" src="./image/arrow-2.png" alt="icon" width="16" height="16"/>'
				document.getElementById("tree").innerHTML = document.getElementById("tree").innerHTML +center;
				tmp=tmp+1;
				childztree = '<div class="center-service" style="display: block;"><div id="ztree'+tmp+'" class="ztree"></div></div>'
				document.getElementById("tree").innerHTML = document.getElementById("tree").innerHTML+childztree;
				setting.async.url=getRootPath()+"/api/v1/ztree/childnodes";
				console.log(setting);
				var treeId = '#ztree'+tmp;
				console.log(treeId);
				$.fn.zTree.init($(treeId), setting, zNodes);

			}
		}
		
		var wsUrl;
		if (window.location.protocol == 'https:') {  
	        wsUrl = 'wss://' + window.location.host + '/monitor/websocket';
		} else {
	        wsUrl = 'ws://' + window.location.host + '/monitor/websocket';
		}
		var cx2;

		//var webSocket = new WebSocket("ws://localhost:8080/monitor/websocket");
		var webSocket = new WebSocket(wsUrl);
		webSocket.onerror = function(event) {
			onError(event)
		};
		webSocket.onopen = function(event) {
			onOpen(event)
		};
		webSocket.onmessage = function(event) {
			onMessage(event)
		};
		webSocket.onclose = function(event){
			console.log("websocket closed");
		}
		function onOpen(event) {
			webSocket.send('hello');
			console.log("connection conn");
		}
		function onError(event) {
			alert(event.data);
			alert("event error");
		}
		var graphic = document.getElementById('graphic');
		var maincanvas = document.getElementById('main');
		maincanvas.width = graphic.scrollWidth;

		function onMessage(event) {
			var json = eval('(' + event.data + ')');
			// var json = event.data;
			console.log(event.data);
			if(json.addNode){
				var node = json.addNode;
				console.log(node);
				var edge = json.addEdge;
				tmp.addNode(node,tmp.data);
				console.log(edge);
				for(var i=0;i<edge.length;i++){
					tmp.addEdge(edge[i]);
					console.log(edge[i]);
				}
				tmp.updateData();
				refresh();
				console.log(tmp);
			}
			else if(json.mainCenterChanged){
				console.log("进来了");
				var nodes1 = tmp.data.nodes;
				var maincenter;
				console.log(json.mainCenterChanged);
				console.log("nodes size is");
				console.log(nodes1.length);
				for(var i = 0;i<nodes1.length;i++){
					if(nodes1[i].group==2){
						console.log("是中心节点 ");
						if(nodes1[i].size==3){
							console.log("原来的主中心");
							console.log(nodes1[i]);
							console.log("现在的size");
							nodes1[i].size=1;
							console.log(nodes1[i]);
						}
						if(nodes1[i].id==json.mainCenterChanged){
							console.log("现在的主中心");
							nodes1[i].size=3;
							console.log(nodes1[i]);
							maincenter=nodes1[i];
						}
					}
				}
				console.log(tmp);
				tmp.updateData();
				refresh();
				if(maincenter.id){
					accessCenterNode(maincenter.id, maincenter.group,maincenter.size);
				}
			}
			else if(json.log){
				console.log(json);
				var loginfo = json.log;
				console.log(loginfo);
				if(loginfo.success){
					var sucessinfo = loginfo.success;
					donghua(sucessinfo.localIp,sucessinfo.remoteIp);
					insert(sucessinfo.message);
				}
				else if(loginfo.failure){
					var failureinfo = loginfo.failure;
					var edges = tmp.data.edges;
					for(var i = 0;i<edges.length;i++){
						if((edges[i].id1==failureinfo.localIp&&edges[i].id2==failureinfo.remoteIp)||(edges[i].id1==failureinfo.remoteIp&&edges[i].id2==failureinfo.localIp)){
							 tmp.data.edges[i].color = 'rgb(105,105,105)';
				 			 tmp.updateData();
						}
					}	
					insert(failureinfo.message);
				}
				else{
				}
			}
			else{			
				cx2 = new CanvasXpress('main',json,
			      {'backgroundGradient1Color': 'rgba(0,0,0,0)',
					 'background':'rgba(0,0,0,0)',
          			'backgroundGradient2Color': 'rgba(0,0,0,0)',
          			'gradient': true,
          			'graphType': 'Network',
		  			'canvasBoxColor' : 'rgb(0,0,0)',
          			'indicatorCenter': 'rainbow',
		  			'decorationsPosition': 'top',
          			'nodeFontColor': 'rgb(255,255,255)',
		  			'networkLayoutType': 'radial',
          			'showAnimation': false},
					{'click' : function(o, e, t) {
						if(o.nodes[0].group==0){  //用户系统	
							accessSysNode(o.nodes[0].id,0)}	
						else if(o.nodes[0].group==1){  //数据访问节点	
							accessANode(o.nodes[0].id,1)}
						else { 	//数据中心
							accessCenterNode(o.nodes[0].id,2);}	

						// var msgBox = document.getElementById('data-network');
						// var closeBtn = document.getElementById('closeButton');
						// closeBtn.onclick=function(){
						// msgBox.style.display = 'none';}
				  	}
			 		}
				);
		}		
	}

		</script>
	</body>
</html>